(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{364:function(t,s,a){t.exports=a.p+"assets/img/you_got_it_dude.267695dc.gif"},380:function(t,s,a){"use strict";a.r(s);var e=a(8),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"lab-4-traffic-management"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#lab-4-traffic-management"}},[t._v("#")]),t._v(" Lab 4 - Traffic Management")]),t._v(" "),e("p",[t._v("In the last laboratory, we will explore an advanced feature of Istio called "),e("a",{attrs:{href:"https://istio.io/latest/docs/tasks/traffic-management/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Traffic Management"),e("OutboundLink")],1),t._v(". Thanks to it, Istio will help you managing the traffic of our microservices very easily.")]),t._v(" "),e("p",[t._v("We will run the following tasks:")]),t._v(" "),e("ol",[e("li",[t._v("Deploy a simple Flask microservice.")]),t._v(" "),e("li",[t._v("Route traffic to it.")]),t._v(" "),e("li",[t._v("Breaks the circuit when timeouts occur.")]),t._v(" "),e("li",[t._v("Perform A/B testing.")])]),t._v(" "),e("h2",{attrs:{id:"_1-traffic-management"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-traffic-management"}},[t._v("#")]),t._v(" 1. Traffic Management")]),t._v(" "),e("p",[t._v("Istio provides a easily way for managing the flow of traffic in an Istio service mesh. The API has allowed users to route requests to specific versions of services, inject delays and failures for resilience testing, add timeouts and circuit breakers, and more, all without changing the application code itself.")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://istio.io/latest/blog/2018/v1alpha3-routing/virtualservices-destrules.svg",alt:"Traffic Management diagram"}})]),t._v(" "),e("p",[t._v("The most important Istio configuration resources to control traffic routing into are")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Gateway")]),t._v(": it configures a load balancer for HTTP/TCP traffic, regardless of where it will be running. Any number of gateways can exist within the mesh and multiple different gateway implementations can co-exist.")]),t._v(" "),e("li",[e("strong",[t._v("VirtualService")]),t._v(": it describes the mapping between one or more user-addressable destinations to the actual destination workloads inside the mesh. This can be particularly useful in facilitating turning monoliths into a composite service built out of distinct microservices without requiring the consumers of the service to adapt to the transition.")]),t._v(" "),e("li",[e("strong",[t._v("DestinationRule")]),t._v(": a DestinationRule configures the set of policies to be applied while forwarding traffic to a service. They are intended to be authored by service owners, describing the circuit breakers, load balancer settings, TLS settings, etc.. DestinationRule is more or less the same as its predecessor, DestinationPolicy.")]),t._v(" "),e("li",[e("strong",[t._v("ServiceEntry")]),t._v(": it is used to add additional entries into the service registry that Istio maintains internally. It is most commonly used to allow one to model traffic to external dependencies of the mesh such as APIs consumed from the web or traffic to services in legacy infrastructure.")])]),t._v(" "),e("p",[t._v("VirtualService, DestinationRule, and ServiceEntry replace RouteRule, DestinationPolicy, and EgressRule respectively. The Gateway is a platform independent abstraction to model the traffic flowing into dedicated middle-boxes.")]),t._v(" "),e("h2",{attrs:{id:"_2-determining-the-application-url"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-determining-the-application-url"}},[t._v("#")]),t._v(" 2. Determining the application URL")]),t._v(" "),e("p",[t._v("As in previous laboratories, firstly we will have to obtain the URL for accessing our application:")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Obtain host and ports:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("INGRESS_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("kubectl -n istio-system get "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" istio-ingressgateway -o "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.spec.ports[?(.name==\"http2\")].nodePort}'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("SECURE_INGRESS_PORT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("kubectl -n istio-system get "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" istio-ingressgateway -o "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.spec.ports[?(.name==\"https\")].nodePort}'")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("INGRESS_HOST")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("minikube "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("GATEWAY_URL")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$INGRESS_HOST")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$INGRESS_PORT")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Run the following command to retrieve the external address of the application.")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_3-deploying-simple-flask-microservice"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-deploying-simple-flask-microservice"}},[t._v("#")]),t._v(" 3. Deploying simple-flask microservice")]),t._v(" "),e("p",[t._v("Before playing with "),e("a",{attrs:{href:"https://istio.io/latest/docs/tasks/traffic-management/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio Traffic Management features"),e("OutboundLink")],1),t._v(", we will create and deploy in Minikube a very simple HTTP server. This first iteration will deploy two different version of a very simple HTTP server.")]),t._v(" "),e("p",[t._v("To do so, follow these steps:")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Download simple-flask repository:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone git@github.com:alvsanand/simple-flask.git\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Build simple-flask docker image:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" simple-flask\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("eval")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("minikube docker-env"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\ndocker build -t alvsanand/simple-flask "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-deployment.yaml"}},[t._v("simple-flask-deployment.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("istioctl kube-inject -f simple-flask-deployment.yaml "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_4-routing-requests"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-routing-requests"}},[t._v("#")]),t._v(" 4. Routing requests")]),t._v(" "),e("p",[t._v("The goal of this exercise is to apply rules that route requests to different versions of our simple-flask in two different ways:")]),t._v(" "),e("ul",[e("li",[t._v("By default.")]),t._v(" "),e("li",[t._v("Based on the value of an HTTP request header.")])]),t._v(" "),e("h3",{attrs:{id:"_4-1-default-routing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-default-routing"}},[t._v("#")]),t._v(" 4.1. Default routing")]),t._v(" "),e("p",[t._v("Firstly, we will explore "),e("a",{attrs:{href:"https://istio.io/latest/docs/tasks/traffic-management/request-routing/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio Request Routing"),e("OutboundLink")],1),t._v(" routing all traffic of our "),e("code",[t._v("simple-flask")]),t._v(" to "),e("code",[t._v("v1")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Gateway\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("istio")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ingressgateway "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# use Istio default gateway implementation")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("servers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" HTTP\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DestinationRule\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subsets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateways")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-routing1.yaml"}},[t._v("simple-flask-networking-routing1.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-routing1.yaml\n\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("It should return something like:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:31:35 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\nHelloworld from Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-routing1.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-routing1.yaml\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_4-1-1-default-routing-but-to-v2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-default-routing-but-to-v2"}},[t._v("#")]),t._v(" 4.1.1 Default routing but to v2")]),t._v(" "),e("p",[t._v("Now, we will modify the VirtualService to route traffic to "),e("code",[t._v("v2")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateways")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-routing11.yaml"}},[t._v("simple-flask-networking-routing1.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-routing11.yaml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("It should return something like:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:35:38 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\nHelloworld from Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-routing11.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-routing11.yaml\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_4-2-based-on-the-value-of-an-http-request-header"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-based-on-the-value-of-an-http-request-header"}},[t._v("#")]),t._v(" 4.2. Based on the value of an HTTP request header")]),t._v(" "),e("p",[t._v("Finally, we will shift traffic based on the HTTP Header "),e("code",[t._v("end-user")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateways")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("headers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("end-user")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exact")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" user"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("v1\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-routing2.yaml"}},[t._v("simple-flask-networking-routing2.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-routing2.yaml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end-user: user-v1'")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("It should return something like:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:36:58 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\nHelloworld from Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),e("p",[t._v("and")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" end-user: user-v1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:36:58 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("83")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\nHelloworld from Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-routing2.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-routing2.yaml\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_5-circuit-breaking"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-circuit-breaking"}},[t._v("#")]),t._v(" 5. Circuit breaking")]),t._v(" "),e("p",[t._v("In this exercise, we will explore "),e("a",{attrs:{href:"https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio Circuit Breaking"),e("OutboundLink")],1),t._v(" routing so we will be able to route traffic when a service responds very slowly.")]),t._v(" "),e("p",[t._v("The steps are:")]),t._v(" "),e("ul",[e("li",[t._v("Deploy a single simple-flask with 1 second delay.")]),t._v(" "),e("li",[t._v("Test the service with delay.")]),t._v(" "),e("li",[t._v("Modify networking to return an error when a timeout happens.")]),t._v(" "),e("li",[t._v("Test the service with circuit-breaking.")])]),t._v(" "),e("p",[t._v("In Istio, managing timeouts for specific request is as simple as adding "),e("code",[t._v("timeout")]),t._v(" parameter to the "),e("code",[t._v("VirtualService")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateways")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100ms\n")])])]),e("h3",{attrs:{id:"_5-1-deploy-simple-flask-with-delays"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-deploy-simple-flask-with-delays"}},[t._v("#")]),t._v(" 5.1. Deploy simple-flask with delays")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-deployment-circuit.yaml"}},[t._v("simple-flask-deployment-circuit.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("istioctl kube-inject -f simple-flask-deployment-circuit.yaml "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_5-2-route-traffic-with-delays"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-route-traffic-with-delays"}},[t._v("#")]),t._v(" 5.2. Route traffic with delays")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-circuit1.yaml"}},[t._v("simple-flask-networking-circuit1.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-circuit1.yaml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("It should return something like after several seconds:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/html"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("utf-8\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("34")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:38:40 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5055")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\nHelloworld from Flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("-DELAY"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-circuit1.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-circuit1.yaml\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_5-3-route-traffic-with-circuit-breaking-enabled"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-route-traffic-with-circuit-breaking-enabled"}},[t._v("#")]),t._v(" 5.3. Route traffic with Circuit Breaking enabled")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-circuit2.yaml"}},[t._v("simple-flask-networking-circuit2.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-circuit2.yaml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v("\n")])])]),e("p",[t._v("It should return something like:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("*   Trying "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("32028")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET / HTTP/1.1\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".49.2:32028\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.68.0\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("408")]),t._v(" Request Timeout\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/plain\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Wed, "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v(" Dec "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 08:40:11 GMT\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 192.168.49.2 left intact")]),t._v("\ndownstream duration "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-circuit1.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-circuit1.yaml\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"_6-traffic-shifting"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-traffic-shifting"}},[t._v("#")]),t._v(" 6. Traffic shifting")]),t._v(" "),e("p",[t._v("In the last exercise, we will deploy an A/B testing deployment strategy using "),e("a",{attrs:{href:"https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio Traffic Shifting"),e("OutboundLink")],1),t._v(" routing.")]),t._v(" "),e("p",[t._v("The step are:")]),t._v(" "),e("ul",[e("li",[t._v("Deploy a simple-flask with 2 different versions.")]),t._v(" "),e("li",[t._v("Deploy networking for A/B testing based on weights.")]),t._v(" "),e("li",[t._v("Test the service with delay.")])]),t._v(" "),e("p",[t._v("In order to make this happen, we must just modify our VirtualService adding two different routes:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" VirtualService\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gateways")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gateway\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("weight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" simple"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flask\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("weight")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("\n")])])]),e("h3",{attrs:{id:"_7-1-a-b-tests"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-a-b-tests"}},[t._v("#")]),t._v(" 7.1. A/B tests")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-deployment.yaml"}},[t._v("simple-flask-deployment.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("istioctl kube-inject -f simple-flask-deployment.yaml "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_7-2-deploy-networking-for-a-b-testing-based-on-weights"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-deploy-networking-for-a-b-testing-based-on-weights"}},[t._v("#")]),t._v(" 7.2. Deploy networking for A/B testing based on weights")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Deploy "),e("a",{attrs:{href:"../simple-flask-networking-circuit1.yaml"}},[t._v("simple-flask-networking-circuit1.yaml")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl apply -f simple-flask-networking-traffic-shifting.yaml\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_7-3-test-and-check-the-proportional-traffic-among-versions"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-test-and-check-the-proportional-traffic-among-versions"}},[t._v("#")]),t._v(" 7.3 Test and check the proportional traffic among versions")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Test the service:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("v1")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("v2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[t._v("i")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -Ss http://"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GATEWAY_URL")]),t._v('"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1.0"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /dev/null "),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("&1")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("v1")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$((")]),t._v("v1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("))")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("v2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$((")]),t._v("v2 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("))")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Responses from V1 = '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$v1")]),t._v('"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Responses from V2 = '),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$v2")]),t._v('"')]),t._v("\n\n")])])]),e("p",[t._v("It should return numbers like:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("Responses from V1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("405")]),t._v("\nResponses from V2 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("95")]),t._v("\n")])])]),e("p",[t._v("This numbers are an approximation of 80% and 20% of the total requests. So they may vary.")])]),t._v(" "),e("li",[e("p",[t._v("Delete "),e("code",[t._v("simple-flask-networking-circuit1.yaml")]),t._v(" resources:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("kubectl delete -f simple-flask-networking-circuit1.yaml\n")])])])])]),t._v(" "),e("br"),t._v(" "),e("br"),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("You finish it!!!")]),t._v(" "),e("p",[t._v("You have reached the end of "),e("strong",[t._v("Istio Workshop")]),t._v(". I hope that you have enjoyed doing it and now you have a good overview of "),e("a",{attrs:{href:"https://www.redhat.com/en/topics/microservices/what-is-a-service-mesh",target:"_blank",rel:"noopener noreferrer"}},[t._v("Service Mesh"),e("OutboundLink")],1),t._v(" and "),e("a",{attrs:{href:"https://istio.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio"),e("OutboundLink")],1),t._v(". For sure, you are more confident in being able to use it in your new developments.")]),t._v(" "),e("p",[e("em",[t._v("Thanks dude!")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(364),alt:"Thanks dude"}})])])])}),[],!1,null,null,null);s.default=n.exports}}]);