<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab 4 - Traffic Management | Istio Workshop</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/istio-workshop/favicon.ico">
    <meta name="description" content="Istio Workshop">
    <meta property="og:site_name" content="Istio Workshop">
    <meta property="og:title" content="Lab 4 - Traffic Management">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://alvsanand.github.io/istio-workshop/laboratory-04/">
    <meta property="og:image" content="https://alvsanand.github.io/istio-workshop/istio_practice_preview.png">
    <meta name="twitter:title" content="Lab 4 - Traffic Management">
    <meta name="twitter:url" content="https://alvsanand.github.io/istio-workshop/laboratory-04/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://alvsanand.github.io/istio-workshop/istio_practice_preview.png">
    
    <link rel="preload" href="/istio-workshop/assets/css/0.styles.1d818571.css" as="style"><link rel="preload" href="/istio-workshop/assets/js/app.3b9c719d.js" as="script"><link rel="preload" href="/istio-workshop/assets/js/2.0a1165e1.js" as="script"><link rel="preload" href="/istio-workshop/assets/js/7.13dcda93.js" as="script"><link rel="prefetch" href="/istio-workshop/assets/js/10.8d9ac37f.js"><link rel="prefetch" href="/istio-workshop/assets/js/11.ae760421.js"><link rel="prefetch" href="/istio-workshop/assets/js/12.d180dbc3.js"><link rel="prefetch" href="/istio-workshop/assets/js/13.e133a97b.js"><link rel="prefetch" href="/istio-workshop/assets/js/14.484c0a8c.js"><link rel="prefetch" href="/istio-workshop/assets/js/3.15eff207.js"><link rel="prefetch" href="/istio-workshop/assets/js/4.a7535257.js"><link rel="prefetch" href="/istio-workshop/assets/js/5.d9a9b260.js"><link rel="prefetch" href="/istio-workshop/assets/js/6.59ae5067.js"><link rel="prefetch" href="/istio-workshop/assets/js/8.495e0370.js"><link rel="prefetch" href="/istio-workshop/assets/js/9.1d3d0d5a.js">
    <link rel="stylesheet" href="/istio-workshop/assets/css/0.styles.1d818571.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/istio-workshop/" class="home-link router-link-active"><img src="/istio-workshop/istio_practice.png" alt="Istio Workshop" class="logo"> <span class="site-name can-hide">Istio Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/istio-workshop/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="@alvsanand" class="dropdown-title"><span class="title">@alvsanand</span> <span class="arrow down"></span></button> <button type="button" aria-label="@alvsanand" class="mobile-dropdown-title"><span class="title">@alvsanand</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinekdIn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://bluetab.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bluetab
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://istio.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Istio
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://istio.io/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Istio docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/istio-workshop/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="@alvsanand" class="dropdown-title"><span class="title">@alvsanand</span> <span class="arrow down"></span></button> <button type="button" aria-label="@alvsanand" class="mobile-dropdown-title"><span class="title">@alvsanand</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.linkedin.com/in/alvsanand" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinekdIn
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://bluetab.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bluetab
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://istio.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Istio
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://istio.io/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Istio docs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/istio-workshop/" aria-current="page" class="sidebar-link">Istio Workshop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/#goals" class="sidebar-link">Goals</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/#index" class="sidebar-link">Index</a></li></ul></li><li><a href="/istio-workshop/technical_overview/" class="sidebar-link">Technical Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#what-is-istio" class="sidebar-link">What is Istio?</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#what-is-a-service-mesh" class="sidebar-link">What is a service mesh?</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#why-use-istio" class="sidebar-link">Why use Istio?</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#core-features" class="sidebar-link">Core features</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#architecture" class="sidebar-link">Architecture</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/technical_overview/#components" class="sidebar-link">Components</a></li></ul></li><li><a href="/istio-workshop/laboratory-01/" class="sidebar-link">Lab 1 - Installing Minkube</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_1-installing-minikube" class="sidebar-link">1. Installing Minikube</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_2-starting-the-cluster" class="sidebar-link">2. Starting the cluster</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_3-interacting-with-k8s" class="sidebar-link">3. Interacting with K8s</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_4-deploying-a-sample-application" class="sidebar-link">4. Deploying a sample application</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_5-deleting-minikube-cluster" class="sidebar-link">5. Deleting minikube cluster</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_6-installing-helm" class="sidebar-link">6. Installing Helm</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-01/#_7-deploying-a-simple-chart" class="sidebar-link">7. Deploying a simple Chart</a></li></ul></li><li><a href="/istio-workshop/laboratory-02/" class="sidebar-link">Lab 2 - Installing Istio</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-02/#_1-downloading-istio" class="sidebar-link">1. Downloading Istio</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-02/#_2-installing-istio-in-minikube" class="sidebar-link">2. Installing Istio in Minikube</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-02/#_3-deploying-a-sample-application" class="sidebar-link">3. Deploying a sample application</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-02/#_4-managing-istio-using-a-dashboard" class="sidebar-link">4. Managing Istio using a dashboard</a></li></ul></li><li><a href="/istio-workshop/laboratory-03/" class="sidebar-link">Lab 3 - Integrating an app</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_1-downloading-microservices-demo-application" class="sidebar-link">1. Downloading microservices-demo application</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_2-testing-microservices-demo-application-without-istio" class="sidebar-link">2. Testing microservices-demo application without Istio</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_3-injecting-istio-sidecar-into-the-application" class="sidebar-link">3. Injecting Istio sidecar into the application</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_4-sidecar-injection" class="sidebar-link">4. Sidecar injection</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_5-deploying-microservices-demo-with-istio" class="sidebar-link">5. Deploying microservices-demo with Istio</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_6-adding-external-https-connectivity-through-istio" class="sidebar-link">6. Adding external HTTPS connectivity through Istio</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_7-checking-services-using-the-istio-dashboard" class="sidebar-link">7. Checking services using the Istio dashboard</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-03/#_8-removing-resources" class="sidebar-link">8. Removing resources</a></li></ul></li><li><a href="/istio-workshop/laboratory-04/" aria-current="page" class="active sidebar-link">Lab 4 - Traffic Management</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_1-traffic-management" class="sidebar-link">1. Traffic Management</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_2-determining-the-application-url" class="sidebar-link">2. Determining the application URL</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_3-deploying-simple-flask-microservice" class="sidebar-link">3. Deploying simple-flask microservice</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_4-routing-requests" class="sidebar-link">4. Routing requests</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_5-circuit-breaking" class="sidebar-link">5. Circuit breaking</a></li><li class="sidebar-sub-header"><a href="/istio-workshop/laboratory-04/#_6-traffic-shifting" class="sidebar-link">6. Traffic shifting</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lab-4-traffic-management"><a href="#lab-4-traffic-management" class="header-anchor">#</a> Lab 4 - Traffic Management</h1> <p>In the last laboratory, we will explore an advanced feature of Istio called <a href="https://istio.io/latest/docs/tasks/traffic-management/" target="_blank" rel="noopener noreferrer">Traffic Management<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Thanks to it, Istio will help you managing the traffic of our microservices very easily.</p> <p>We will run the following tasks:</p> <ol><li>Deploy a simple Flask microservice.</li> <li>Route traffic to it.</li> <li>Breaks the circuit when timeouts occur.</li> <li>Perform A/B testing.</li></ol> <h2 id="_1-traffic-management"><a href="#_1-traffic-management" class="header-anchor">#</a> 1. Traffic Management</h2> <p>Istio provides a easily way for managing the flow of traffic in an Istio service mesh. The API has allowed users to route requests to specific versions of services, inject delays and failures for resilience testing, add timeouts and circuit breakers, and more, all without changing the application code itself.</p> <p><img src="https://istio.io/latest/blog/2018/v1alpha3-routing/virtualservices-destrules.svg" alt="Traffic Management diagram"></p> <p>The most important Istio configuration resources to control traffic routing into are</p> <ul><li><strong>Gateway</strong>: it configures a load balancer for HTTP/TCP traffic, regardless of where it will be running. Any number of gateways can exist within the mesh and multiple different gateway implementations can co-exist.</li> <li><strong>VirtualService</strong>: it describes the mapping between one or more user-addressable destinations to the actual destination workloads inside the mesh. This can be particularly useful in facilitating turning monoliths into a composite service built out of distinct microservices without requiring the consumers of the service to adapt to the transition.</li> <li><strong>DestinationRule</strong>: a DestinationRule configures the set of policies to be applied while forwarding traffic to a service. They are intended to be authored by service owners, describing the circuit breakers, load balancer settings, TLS settings, etc.. DestinationRule is more or less the same as its predecessor, DestinationPolicy.</li> <li><strong>ServiceEntry</strong>: it is used to add additional entries into the service registry that Istio maintains internally. It is most commonly used to allow one to model traffic to external dependencies of the mesh such as APIs consumed from the web or traffic to services in legacy infrastructure.</li></ul> <p>VirtualService, DestinationRule, and ServiceEntry replace RouteRule, DestinationPolicy, and EgressRule respectively. The Gateway is a platform independent abstraction to model the traffic flowing into dedicated middle-boxes.</p> <h2 id="_2-determining-the-application-url"><a href="#_2-determining-the-application-url" class="header-anchor">#</a> 2. Determining the application URL</h2> <p>As in previous laboratories, firstly we will have to obtain the URL for accessing our application:</p> <ol><li><p>Obtain host and ports:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl -n istio-system get <span class="token function">service</span> istio-ingressgateway -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(.name==&quot;http2&quot;)].nodePort}'</span><span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl -n istio-system get <span class="token function">service</span> istio-ingressgateway -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(.name==&quot;https&quot;)].nodePort}'</span><span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>minikube <span class="token function">ip</span><span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GATEWAY_URL</span><span class="token operator">=</span><span class="token variable">$INGRESS_HOST</span><span class="token builtin class-name">:</span><span class="token variable">$INGRESS_PORT</span>
</code></pre></div></li> <li><p>Run the following command to retrieve the external address of the application.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div></li></ol> <h2 id="_3-deploying-simple-flask-microservice"><a href="#_3-deploying-simple-flask-microservice" class="header-anchor">#</a> 3. Deploying simple-flask microservice</h2> <p>Before playing with <a href="https://istio.io/latest/docs/tasks/traffic-management/" target="_blank" rel="noopener noreferrer">Istio Traffic Management features<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, we will create and deploy in Minikube a very simple HTTP server. This first iteration will deploy two different version of a very simple HTTP server.</p> <p>To do so, follow these steps:</p> <ul><li><p>Download simple-flask repository:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> clone git@github.com:alvsanand/simple-flask.git
</code></pre></div></li> <li><p>Build simple-flask docker image:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> simple-flask
<span class="token builtin class-name">eval</span> <span class="token variable"><span class="token variable">$(</span>minikube docker-env<span class="token variable">)</span></span>
docker build -t alvsanand/simple-flask <span class="token builtin class-name">.</span>
</code></pre></div></li> <li><p>Deploy <a href="../simple-flask-deployment.yaml">simple-flask-deployment.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>istioctl kube-inject -f simple-flask-deployment.yaml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div></li></ul> <h2 id="_4-routing-requests"><a href="#_4-routing-requests" class="header-anchor">#</a> 4. Routing requests</h2> <p>The goal of this exercise is to apply rules that route requests to different versions of our simple-flask in two different ways:</p> <ul><li>By default.</li> <li>Based on the value of an HTTP request header.</li></ul> <h3 id="_4-1-default-routing"><a href="#_4-1-default-routing" class="header-anchor">#</a> 4.1. Default routing</h3> <p>Firstly, we will explore <a href="https://istio.io/latest/docs/tasks/traffic-management/request-routing/" target="_blank" rel="noopener noreferrer">Istio Request Routing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> routing all traffic of our <code>simple-flask</code> to <code>v1</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><ul><li><p>Deploy <a href="../simple-flask-networking-routing1.yaml">simple-flask-networking-routing1.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-routing1.yaml

</code></pre></div></li> <li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div><p>It should return something like:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> content-length: <span class="token number">28</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:31:35 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">20</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
Helloworld from Flask<span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">!</span>
</code></pre></div></li> <li><p>Delete <code>simple-flask-networking-routing1.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-routing1.yaml
</code></pre></div></li></ul> <h3 id="_4-1-1-default-routing-but-to-v2"><a href="#_4-1-1-default-routing-but-to-v2" class="header-anchor">#</a> 4.1.1 Default routing but to v2</h3> <p>Now, we will modify the VirtualService to route traffic to <code>v2</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><ul><li><p>Deploy <a href="../simple-flask-networking-routing11.yaml">simple-flask-networking-routing1.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-routing11.yaml
</code></pre></div></li> <li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div><p>It should return something like:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> content-length: <span class="token number">28</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:35:38 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">58</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
Helloworld from Flask<span class="token punctuation">[</span><span class="token number">2.0</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">!</span>
</code></pre></div></li> <li><p>Delete <code>simple-flask-networking-routing11.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-routing11.yaml
</code></pre></div></li></ul> <h3 id="_4-2-based-on-the-value-of-an-http-request-header"><a href="#_4-2-based-on-the-value-of-an-http-request-header" class="header-anchor">#</a> 4.2. Based on the value of an HTTP request header</h3> <p>Finally, we will shift traffic based on the HTTP Header <code>end-user</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
            <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
              <span class="token key atrule">exact</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>v1
      <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><ul><li><p>Deploy <a href="../simple-flask-networking-routing2.yaml">simple-flask-networking-routing2.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-routing2.yaml
</code></pre></div></li> <li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
<span class="token function">curl</span> -H <span class="token string">'end-user: user-v1'</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div><p>It should return something like:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> content-length: <span class="token number">28</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:36:58 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">13</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
Helloworld from Flask<span class="token punctuation">[</span><span class="token number">2.0</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">!</span>
</code></pre></div><p>and</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> end-user: user-v1
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> content-length: <span class="token number">28</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:36:58 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">83</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
Helloworld from Flask<span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">!</span>
</code></pre></div></li> <li><p>Delete <code>simple-flask-networking-routing2.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-routing2.yaml
</code></pre></div></li></ul> <h2 id="_5-circuit-breaking"><a href="#_5-circuit-breaking" class="header-anchor">#</a> 5. Circuit breaking</h2> <p>In this exercise, we will explore <a href="https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/" target="_blank" rel="noopener noreferrer">Istio Circuit Breaking<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> routing so we will be able to route traffic when a service responds very slowly.</p> <p>The steps are:</p> <ul><li>Deploy a single simple-flask with 1 second delay.</li> <li>Test the service with delay.</li> <li>Modify networking to return an error when a timeout happens.</li> <li>Test the service with circuit-breaking.</li></ul> <p>In Istio, managing timeouts for specific request is as simple as adding <code>timeout</code> parameter to the <code>VirtualService</code>:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 100ms
</code></pre></div><h3 id="_5-1-deploy-simple-flask-with-delays"><a href="#_5-1-deploy-simple-flask-with-delays" class="header-anchor">#</a> 5.1. Deploy simple-flask with delays</h3> <ul><li><p>Deploy <a href="../simple-flask-deployment-circuit.yaml">simple-flask-deployment-circuit.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>istioctl kube-inject -f simple-flask-deployment-circuit.yaml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div></li></ul> <h3 id="_5-2-route-traffic-with-delays"><a href="#_5-2-route-traffic-with-delays" class="header-anchor">#</a> 5.2. Route traffic with delays</h3> <ul><li><p>Deploy <a href="../simple-flask-networking-circuit1.yaml">simple-flask-networking-circuit1.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-circuit1.yaml
</code></pre></div></li> <li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div><p>It should return something like after several seconds:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token operator">&lt;</span> content-length: <span class="token number">34</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:38:40 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">5055</span>
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
Helloworld from Flask<span class="token punctuation">[</span><span class="token number">1.0</span>-DELAY<span class="token punctuation">]</span><span class="token operator">!</span><span class="token operator">!</span>
</code></pre></div></li> <li><p>Delete <code>simple-flask-networking-circuit1.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-circuit1.yaml
</code></pre></div></li></ul> <h3 id="_5-3-route-traffic-with-circuit-breaking-enabled"><a href="#_5-3-route-traffic-with-circuit-breaking-enabled" class="header-anchor">#</a> 5.3. Route traffic with Circuit Breaking enabled</h3> <ul><li><p>Deploy <a href="../simple-flask-networking-circuit2.yaml">simple-flask-networking-circuit2.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-circuit2.yaml
</code></pre></div></li> <li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> -v http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span>
</code></pre></div><p>It should return something like:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>*   Trying <span class="token number">192.168</span>.49.2:32028<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">192.168</span>.49.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.49.2<span class="token punctuation">)</span> port <span class="token number">32028</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">192.168</span>.49.2:32028
<span class="token operator">&gt;</span> User-Agent: curl/7.68.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">408</span> Request Timeout
<span class="token operator">&lt;</span> content-length: <span class="token number">27</span>
<span class="token operator">&lt;</span> content-type: text/plain
<span class="token operator">&lt;</span> date: Wed, <span class="token number">30</span> Dec <span class="token number">2020</span> 08:40:11 GMT
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 192.168.49.2 left intact</span>
downstream duration <span class="token function">timeout</span>
</code></pre></div></li> <li><p>Delete <code>simple-flask-networking-circuit1.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-circuit1.yaml
</code></pre></div></li></ul> <h2 id="_6-traffic-shifting"><a href="#_6-traffic-shifting" class="header-anchor">#</a> 6. Traffic shifting</h2> <p>In the last exercise, we will deploy an A/B testing deployment strategy using <a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/" target="_blank" rel="noopener noreferrer">Istio Traffic Shifting<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> routing.</p> <p>The step are:</p> <ul><li>Deploy a simple-flask with 2 different versions.</li> <li>Deploy networking for A/B testing based on weights.</li> <li>Test the service with delay.</li></ul> <p>In order to make this happen, we must just modify our VirtualService adding two different routes:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
    <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> simple<span class="token punctuation">-</span>flask<span class="token punctuation">-</span>gateway
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> simple<span class="token punctuation">-</span>flask
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre></div><h3 id="_7-1-a-b-tests"><a href="#_7-1-a-b-tests" class="header-anchor">#</a> 7.1. A/B tests</h3> <ul><li><p>Deploy <a href="../simple-flask-deployment.yaml">simple-flask-deployment.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>istioctl kube-inject -f simple-flask-deployment.yaml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div></li></ul> <h3 id="_7-2-deploy-networking-for-a-b-testing-based-on-weights"><a href="#_7-2-deploy-networking-for-a-b-testing-based-on-weights" class="header-anchor">#</a> 7.2. Deploy networking for A/B testing based on weights</h3> <ul><li><p>Deploy <a href="../simple-flask-networking-circuit1.yaml">simple-flask-networking-circuit1.yaml</a> file:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl apply -f simple-flask-networking-traffic-shifting.yaml
</code></pre></div></li></ul> <h3 id="_7-3-test-and-check-the-proportional-traffic-among-versions"><a href="#_7-3-test-and-check-the-proportional-traffic-among-versions" class="header-anchor">#</a> 7.3 Test and check the proportional traffic among versions</h3> <ul><li><p>Test the service:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">v1</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">v2</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">500</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -Ss http://<span class="token string">&quot;<span class="token variable">$GATEWAY_URL</span>&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;1.0&quot;</span> <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">v1</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>v1 <span class="token operator">+</span> <span class="token number">1</span><span class="token variable">))</span></span>
    <span class="token keyword">else</span>
        <span class="token assign-left variable">v2</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$((</span>v2 <span class="token operator">+</span> <span class="token number">1</span><span class="token variable">))</span></span>
    <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;Responses from V1 = <span class="token variable">$v1</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Responses from V2 = <span class="token variable">$v2</span>&quot;</span>

</code></pre></div><p>It should return numbers like:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Responses from V1 <span class="token operator">=</span> <span class="token number">405</span>
Responses from V2 <span class="token operator">=</span> <span class="token number">95</span>
</code></pre></div><p>This numbers are an approximation of 80% and 20% of the total requests. So they may vary.</p></li> <li><p>Delete <code>simple-flask-networking-circuit1.yaml</code> resources:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>kubectl delete -f simple-flask-networking-circuit1.yaml
</code></pre></div></li></ul> <br> <br> <div class="custom-block tip"><p class="custom-block-title">You finish it!!!</p> <p>You have reached the end of <strong>Istio Workshop</strong>. I hope that you have enjoyed doing it and now you have a good overview of <a href="https://www.redhat.com/en/topics/microservices/what-is-a-service-mesh" target="_blank" rel="noopener noreferrer">Service Mesh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://istio.io/" target="_blank" rel="noopener noreferrer">Istio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. For sure, you are more confident in being able to use it in your new developments.</p> <p><em>Thanks dude!</em></p> <p><img src="/istio-workshop/assets/img/you_got_it_dude.267695dc.gif" alt="Thanks dude"></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/istio-workshop/laboratory-03/" class="prev">
        Lab 3 - Integrating an app
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/istio-workshop/assets/js/app.3b9c719d.js" defer></script><script src="/istio-workshop/assets/js/2.0a1165e1.js" defer></script><script src="/istio-workshop/assets/js/7.13dcda93.js" defer></script>
  </body>
</html>
